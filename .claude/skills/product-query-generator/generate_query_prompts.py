#!/usr/bin/env python3
"""
Generate Query Prompts Script for Manual AI Agent Query Generation

This script reads preference_match.json and generates detailed prompts for AI agents
to manually create natural, human-like Amazon search queries.

KEY REQUIREMENTS:
- Each query MUST include ALL 3 product attributes
- Attributes must undergo SEMANTIC TRANSFORMATION (not copy-paste)
- Target length: 25-30 words (not characters)
- Each query must be MANUALLY generated by AI reading the prompt
No automated or template-based generation allowed.

Output: JSON file with prompts for each product, ready for AI agent processing.
"""

import json
import os
import argparse

def generate_prompt(asin, category, attributes):
    attr_list = "\n".join([f"{i+1}. {attr}" for i, attr in enumerate(attributes)])
    prompt = f"""You are a shopper looking for a [ {category} ] product on Amazon.

**Product Attributes (MUST include ALL 3):**
{attr_list}

**Task:**
Generate a natural, human-like search query based on these attributes.

**CRITICAL Requirements:**
1. **MUST include ALL 3 attributes** - Do not skip any attribute.
2. **Semantic Transformation Required**:
   - DO NOT copy-paste attributes directly
   - Transform attributes into natural shopping language
   - Example: "Long-lasting/Durable" → "lasts a long time" or "won't wear out"
   - Example: "High pigment concentration" → "rich colors that cover well"
   - Example: "Compact packaging" → "easy to carry around" or "fits in my bag"
3. **Length**: Exactly 25-30 words (count words, not characters).
4. **Perspective**: First person natural tone (e.g., "I need...", "Looking for...").
5. **Human Generation Required**: Each query must be manually generated by reading the prompt and applying semantic transformation. No automated or template-based generation.

**Output Format:**
Output ONLY the polished query text. No explanations, no prefixes, no extra punctuation.

**Example Transformation:**
Attributes: ["Pearlescent shimmer", "Long-lasting/Durable", "High pigment concentration"]
❌ Bad: "fabric paint with pearlescent shimmer long-lasting durable high pigment concentration"
✅ Good: "I need fabric paint that shimmers and lasts through many projects with rich concentrated colors for my crafts"
"""
    return prompt

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--input", default="/home/wlia0047/ar57/wenyu/result/preference_match/preference_match.json", help="Path to preference_match.json")
    parser.add_argument("--output", default="/home/wlia0047/ar57/wenyu/result/clean_query/query_prompts.json", help="Path to save generated prompts")
    args = parser.parse_args()

    if not os.path.exists(args.input):
        print(f"❌ Input file not found: {args.input}")
        return

    with open(args.input, 'r') as f:
        data = json.load(f)

    output_data = []
    for item in data:
        asin = item.get("target_asin")
        category = item.get("category", "Unknown")
        attributes = item.get("selected_attributes", [])
        
        if not asin or not attributes:
            continue
            
        prompt_text = generate_prompt(asin, category, attributes)
        output_data.append({
            "target_asin": asin,
            "prompt": prompt_text
        })

    os.makedirs(os.path.dirname(args.output), exist_ok=True)
    with open(args.output, 'w') as f:
        json.dump(output_data, f, indent=2, ensure_ascii=False)

    print(f"✅ Generated {len(output_data)} query prompts and saved to {args.output}")

if __name__ == "__main__":
    main()
